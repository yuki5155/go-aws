AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'sample-app

  Sample SAM Template for sample-app

  '
Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
    - dev
    - stg
    - prd
    Description: Environment name
  CustomDomainName:
    Type: String
    Description: Custom domain name
  HostedZoneId:
    Type: String
    Description: Hosted zone ID
  CertificateArn:
    Type: String
    Description: ARN of existing ACM certificate
  CookieDomain:
    Type: String
    Description: Cookie domain
    Default: ''
  AllowOrigin:
    Type: String
    Description: CORS allow origin
    Default: https://mydevportal.com
  CognitoDomain:
    Type: String
    Description: Cognito domain name
    Default: ''
  CognitoClientID:
    Type: String
    Description: Cognito app client ID
    Default: ''
  CognitoClientSecret:
    Type: String
    Description: Cognito app client secret
    Default: ''
  CognitoUserPoolID:
    Type: String
    Description: Cognito user pool ID
    Default: ''
  CognitoCallbackURL:
    Type: String
    Description: Cognito callback URL
    Default: ''
Globals:
  Function:
    Timeout: 5
    MemorySize: 128
    Tracing: Active
Resources:
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName:
        Ref: Environment
      EndpointConfiguration: REGIONAL
      TracingEnabled: true
      OpenApiVersion: 3.0.1
      Cors:
        AllowMethods: '''GET,POST,PUT,DELETE,OPTIONS'''
        AllowHeaders: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
        AllowOrigin: '''https://mydevportal.com'''
        AllowCredentials: true
      DefinitionBody:
        openapi: 3.0.1
        info:
          title: API Gateway
          version: '1.0'
        paths:
          /hello:
            options:
              summary: CORS support for hello endpoint
              description: Enable CORS by returning correct headers
              responses:
                '200':
                  description: Default response for CORS method
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: string
                    Access-Control-Allow-Methods:
                      schema:
                        type: string
                    Access-Control-Allow-Headers:
                      schema:
                        type: string
                    Access-Control-Allow-Credentials:
                      schema:
                        type: boolean
                  content: {}
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: "{\n  \"statusCode\": 200\n}\n"
                responses:
                  default:
                    statusCode: '200'
                    responseParameters:
                      method.response.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
                      method.response.header.Access-Control-Allow-Methods: '''GET,POST,PUT,DELETE,OPTIONS'''
                      method.response.header.Access-Control-Allow-Origin: '''https://mydevportal.com'''
                      method.response.header.Access-Control-Allow-Credentials: '''true'''
                    responseTemplates:
                      application/json: '{}

                        '
            get:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${HelloWorldFunction.Arn}/invocations
                passthroughBehavior: when_no_match
              responses:
                '200':
                  description: 200 response
          /users/get:
            options:
              summary: CORS support for users/get endpoint
              description: Enable CORS by returning correct headers
              responses:
                '200':
                  description: Default response for CORS method
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: string
                    Access-Control-Allow-Methods:
                      schema:
                        type: string
                    Access-Control-Allow-Headers:
                      schema:
                        type: string
                    Access-Control-Allow-Credentials:
                      schema:
                        type: boolean
                  content: {}
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: "{\n  \"statusCode\": 200\n}\n"
                responses:
                  default:
                    statusCode: '200'
                    responseParameters:
                      method.response.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
                      method.response.header.Access-Control-Allow-Methods: '''GET,POST,PUT,DELETE,OPTIONS'''
                      method.response.header.Access-Control-Allow-Origin: '''https://mydevportal.com'''
                      method.response.header.Access-Control-Allow-Credentials: '''true'''
                    responseTemplates:
                      application/json: '{}

                        '
            get:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetUserFunction.Arn}/invocations
                passthroughBehavior: when_no_match
              responses:
                '200':
                  description: 200 response
          /hello-post:
            options:
              summary: CORS support for hello-post endpoint
              description: Enable CORS by returning correct headers
              responses:
                '200':
                  description: Default response for CORS method
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: string
                    Access-Control-Allow-Methods:
                      schema:
                        type: string
                    Access-Control-Allow-Headers:
                      schema:
                        type: string
                    Access-Control-Allow-Credentials:
                      schema:
                        type: boolean
                  content: {}
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: "{\n  \"statusCode\": 200\n}\n"
                responses:
                  default:
                    statusCode: '200'
                    responseParameters:
                      method.response.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
                      method.response.header.Access-Control-Allow-Methods: '''GET,POST,PUT,DELETE,OPTIONS'''
                      method.response.header.Access-Control-Allow-Origin: '''https://mydevportal.com'''
                      method.response.header.Access-Control-Allow-Credentials: '''true'''
                    responseTemplates:
                      application/json: '{}

                        '
            post:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${HelloWorldPostFunction.Arn}/invocations
                passthroughBehavior: when_no_match
              responses:
                '200':
                  description: 200 response
          /callback:
            options:
              summary: CORS support for callback endpoint
              description: Enable CORS by returning correct headers
              responses:
                '200':
                  description: Default response for CORS method
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: string
                    Access-Control-Allow-Methods:
                      schema:
                        type: string
                    Access-Control-Allow-Headers:
                      schema:
                        type: string
                    Access-Control-Allow-Credentials:
                      schema:
                        type: boolean
                  content: {}
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: "{\n  \"statusCode\": 200\n}\n"
                responses:
                  default:
                    statusCode: '200'
                    responseParameters:
                      method.response.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
                      method.response.header.Access-Control-Allow-Methods: '''GET,POST,PUT,DELETE,OPTIONS'''
                      method.response.header.Access-Control-Allow-Origin: '''https://mydevportal.com'''
                      method.response.header.Access-Control-Allow-Credentials: '''true'''
                    responseTemplates:
                      application/json: '{}

                        '
            post:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CallbackFunction.Arn}/invocations
                passthroughBehavior: when_no_match
              responses:
                '200':
                  description: 200 response
        x-amazon-apigateway-binary-media-types:
        - image/*
        x-amazon-apigateway-cors:
          allowOrigins:
          - '''https://mydevportal.com'''
          allowMethods:
          - '''GET,POST,PUT,DELETE,OPTIONS'''
          allowHeaders:
          - '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
          allowCredentials: true
  ApiCustomDomain:
    Type: AWS::ApiGateway::DomainName
    Properties:
      DomainName:
        Ref: CustomDomainName
      RegionalCertificateArn:
        Ref: CertificateArn
      EndpointConfiguration:
        Types:
        - REGIONAL
      SecurityPolicy: TLS_1_2
  ApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
    - HelloGet
    - HelloWorldPostFunction
    - CallbackFunction
    Properties:
      RestApiId:
        Ref: ApiGateway
      Description: Deployment for API Gateway
  ApiStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId:
        Ref: ApiGateway
      DeploymentId:
        Ref: ApiDeployment
      StageName:
        Fn::Sub: ${Environment}-apigw-1
  ApiBasePath:
    Type: AWS::ApiGateway::BasePathMapping
    DependsOn:
    - ApiStage
    Properties:
      DomainName:
        Ref: CustomDomainName
      RestApiId:
        Ref: ApiGateway
      Stage:
        Ref: Environment
      BasePath: api
  ApiDnsRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:
        Ref: HostedZoneId
      Name:
        Ref: CustomDomainName
      Type: A
      AliasTarget:
        DNSName:
          Fn::GetAtt:
          - ApiCustomDomain
          - RegionalDomainName
        HostedZoneId:
          Fn::GetAtt:
          - ApiCustomDomain
          - RegionalHostedZoneId
  GatewayResponse4XX:
    Type: AWS::ApiGateway::GatewayResponse
    Properties:
      ResponseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: '''https://mydevportal.com'''
        gatewayresponse.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
        gatewayresponse.header.Access-Control-Allow-Methods: '''GET,POST,PUT,DELETE,OPTIONS'''
        gatewayresponse.header.Access-Control-Allow-Credentials: '''true'''
      ResponseType: DEFAULT_4XX
      RestApiId:
        Ref: ApiGateway
  GatewayResponse5XX:
    Type: AWS::ApiGateway::GatewayResponse
    Properties:
      ResponseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: '''https://mydevportal.com'''
        gatewayresponse.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
        gatewayresponse.header.Access-Control-Allow-Methods: '''GET,POST,PUT,DELETE,OPTIONS'''
        gatewayresponse.header.Access-Control-Allow-Credentials: '''true'''
      ResponseType: DEFAULT_5XX
      RestApiId:
        Ref: ApiGateway
  HelloWorldFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: HelloWorldFunction
    Properties:
      CodeUri: HelloWorldFunction
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - x86_64
      Events:
        HelloGet:
          Type: Api
          Properties:
            Path: /hello
            Method: GET
            RestApiId:
              Ref: ApiGateway
      Environment:
        Variables:
          GOCACHE: /tmp/.cache/go-build
          GOPATH: /tmp/go
          COOKIE_DOMAIN:
            Ref: CookieDomain
          ALLOW_ORIGIN:
            Ref: AllowOrigin
  HelloWorldPostFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: HelloWorldPostFunction
    Properties:
      CodeUri: HelloWorldPostFunction
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - x86_64
      Events:
        HelloPost:
          Type: Api
          Properties:
            Path: /hello-post
            Method: POST
            RestApiId:
              Ref: ApiGateway
      Environment:
        Variables:
          GOCACHE: /tmp/.cache/go-build
          GOPATH: /tmp/go
          COOKIE_DOMAIN:
            Ref: CookieDomain
          ALLOW_ORIGIN:
            Ref: AllowOrigin
  CallbackFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: CallbackFunction
    Properties:
      CodeUri: CallbackFunction
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - x86_64
      Events:
        Callback:
          Type: Api
          Properties:
            Path: /callback
            Method: POST
            RestApiId:
              Ref: ApiGateway
      Environment:
        Variables:
          GOCACHE: /tmp/.cache/go-build
          GOPATH: /tmp/go
          COOKIE_DOMAIN:
            Ref: CookieDomain
          ALLOW_ORIGIN:
            Ref: AllowOrigin
          COGNITO_DOMAIN:
            Ref: CognitoDomain
          COGNITO_CLIENT_ID:
            Ref: CognitoClientID
          COGNITO_CLIENT_SECRET:
            Ref: CognitoClientSecret
          COGNITO_USER_POOL_ID:
            Ref: CognitoUserPoolID
          COGNITO_CALLBACK_URL:
            Ref: CognitoCallbackURL
  HelloGet:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: ApiGateway
      ResourceId:
        Fn::GetAtt:
        - ApiGateway
        - RootResourceId
      HttpMethod: GET
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${HelloWorldFunction.Arn}/invocations
  GetUserFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: GetUserFunction
    Properties:
      CodeUri: GetUserFunction
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - x86_64
      Events:
        GetUser:
          Type: Api
          Properties:
            Path: /users/get
            Method: GET
            RestApiId:
              Ref: ApiGateway
      Environment:
        Variables:
          GOCACHE: /tmp/.cache/go-build
          GOPATH: /tmp/go
          ALLOW_ORIGIN:
            Ref: AllowOrigin
  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name:
        Fn::Join:
        - ''
        - - ApplicationInsights-SAM-
          - Ref: AWS::StackName
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0
  ApplicationInsightsMonitoring:
    Type: AWS::ApplicationInsights::Application
    Properties:
      ResourceGroupName:
        Fn::Join:
        - ''
        - - ApplicationInsights-SAM-
          - Ref: AWS::StackName
      AutoConfigurationEnabled: 'true'
    DependsOn: ApplicationResourceGroup
Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL
    Value:
      Fn::Sub: https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/
  CustomDomainUrl:
    Description: Custom domain URL
    Value:
      Fn::Sub: https://${CustomDomainName}/api/
  ApiGatewayRestApiId:
    Description: API Gateway REST API ID
    Value:
      Ref: ApiGateway
  ApiGatewayRestApiStage:
    Description: API Gateway REST API Stage
    Value:
      Ref: Environment
